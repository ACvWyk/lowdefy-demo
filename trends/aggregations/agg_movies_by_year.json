{
  "name": "agg_movies_by_year",
  "type": "mongodb_aggregation",
  "connectionId": "mongodb_mflix_movies",
  "linkedTo": [
    "_state.filter.filter_select_month_from",
    "_state.filter.filter_select_month_to",
    "_state.filter.filter_select_type",
    "_state.filter.filter_select_genre",
    "_state.filter.filter_select_country",
    "_state.filter.filter_select_language",
    "_state.filter.filter_calculate_button"
  ],
  "properties": {
    "pipeline": [
      { 
        "$group": {
          "_id": { "$dateFromParts": { "year": { "$year": "$released" } } },
          "count": { "$sum": 1 },
          "avg_imdb": { "$avg": "$imdb.rating" }
        }
      },
      { 
        "$addFields": {
          "year": "$id"  
        }
      },
      {
        "$sort": { 
          "year": 1 
        }
      }
    ]
  }
}
